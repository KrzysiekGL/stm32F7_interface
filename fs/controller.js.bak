var xhr;

function prepareXMLHttpRequest() {
  xhr = new(XMLHttpRequest);
  getLEDStatus();
}

window.onload = prepareXMLHttpRequest;

//-----------------------------------------------------
/* Odczytanie stanu wszystkich LED */
function getLEDStatus() {
  nocache = "&nocache=" + Math.random() * 1000000;
  var request = new XMLHttpRequest();
  request.onreadystatechange = function() {
    if(this.readyState == 4 && this.status == 200 && this.responseText != null) {
      var msg = this.responseText;

      if (msg.indexOf('1O') != -1)
        document.getElementById("led0").style.background = "#10BF45";
      else
        document.getElementById("led0").style.background = "#Bf1020";

      if(msg.indexOf('2O') != -1)
        document.getElementById("led1").style.background = "#10BF45";
      else
        document.getElementById("led1").style.background = "#Bf1020";

      if(msg.indexOf('3O') != -1)
        document.getElementById("led2").style.background = "#10BF45";
      else
        document.getElementById("led2").style.background = "#Bf1020";

      if(msg.indexOf('40') != -1)
        document.getElementById("led3").style.background = "#10BF45";
      else
        document.getElementById("led3").style.background = "#Bf1020";
    }
  }

  request.open("GET", "relay.html?A" + nocache, true);
  request.send(null);

  //setTimeout("getLEDStatus()", 1000);
}

//-----------------------------------------------------
/* Sterowanie przekaźnikami */
function GetRelayState(val) {
  nocache = "&nocache=" + Math.random() * 1000000;
  var request = new XMLHttpRequest();
  request.onreadystatechange = function(){
    if(this.readyState == 4){
      if(this.status == 200){
        if(this.responseText != null){
          var msg = this.responseText;
          if(val == 1) {
            if(msg.includes("relay.html?r=1_On") == true) {
              document.getElementById("controlRelayBtn1").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #000000; background-color: #00ff00;" onclick="GetRelayState()" value="Przekaźnik 1 ON"/>';
            }
            else {
              document.getElementById("controlRelayBtn1").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #00ffff; background-color: #ff0000;" onclick="GetRelayState()" value="Przekaźnik 1 OFF"/>';
            }
          }
          else if(val == 2) {
            if(msg.includes("relay.html?r=2_On") == true) {
              document.getElementById("controlRelayBtn2").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #000000; background-color: #00ff00;" onclick="GetRelayState()" value="Przekaźnik 2 ON"/>';
            }
            else {
              document.getElementById("controlRelayBtn2").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #00ffff; background-color: #ff0000;" onclick="GetRelayState()" value="Przekaźnik 2 OFF"/>';
            }
          }
          else if(val == 3) {
            if(msg.includes("relay.html?r=3_On") == true) {
              document.getElementById("controlRelayBtn3").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #000000; background-color: #00ff00;" onclick="GetRelayState()" value="Przekaźnik 3 ON"/>';
            }
            else {
              document.getElementById("controlRelayBtn3").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #00ffff; background-color: #ff0000;" onclick="GetRelayState()" value="Przekaźnik 3 OFF"/>';
            }
          }
          else if(val == 4) {
            if(msg.includes("relay.html?r=4_On") == true) {
              document.getElementById("controlRelayBtn4").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #000000; background-color: #00ff00;" onclick="GetRelayState()" value="Przekaźnik 4 ON"/>';
            }
            else {
              document.getElementById("controlRelayBtn4").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #00ffff; background-color: #ff0000;" onclick="GetRelayState()" value="Przekaźnik 4 OFF"/>';
            }
          }
          else if(val == 5) {
            if(msg.includes("relay.html?r=5_On") == true) {
              document.getElementById("controlRelayBtn5").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #000000; background-color: #00ff00;" onclick="GetRelayState()" value="Przekaźnik 5 ON"/>';
            }
            else {
              document.getElementById("controlRelayBtn5").innerHTML = '<input class = "controlRelayBtn" type="button" style="color: #00ffff; background-color: #ff0000;" onclick="GetRelayState()" value="Przekaźnik 5 OFF"/>';
            }
          }
        }
      }
    }
  }

  if(val == 1) {
    request.open("GET", "relay.html?r=1" + nocache, true);
    request.send(null);
  }
  else if(val == 2) {
    request.open("GET", "relay.html?r=2" + nocache, true);
    request.send(null);
  }
  else if(val == 3) {
    request.open("GET", "relay.html?r=3" + nocache, true);
    request.send(null);
  }
  else if(val == 4) {
    request.open("GET", "relay.html?r=4" + nocache, true);
    request.send(null);
  }
  else if(val == 5) {
    request.open("GET", "relay.html?r=5" + nocache, true);
    request.send(null);
  }

}

//-----------------------------------------------------
//Odczyt liczby 8 bit
function loadTempFromDevice() {
  nocache = "&nocache=" + Math.random() * 1000000;
  var request = new XMLHttpRequest();
  request.onreadystatechange = function(){
    if(this.readyState == 4) {
      if(this.status == 200) {
        if(this.responseText != null) {
          var msg = this.responseText;
          var msgToDisplay = msg.substring(17, 21);
          document.getElementById("readedTempLbl").innerHTML = "Temperatura: " + msgToDisplay;
        }
      }
    }
  }
  request.open("GET", "temp.html?T=" + nocache, true);
  request.send(null);

}
